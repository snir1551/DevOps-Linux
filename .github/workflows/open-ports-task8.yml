name: Open NSG Ports for Task 8

on:
  workflow_call:

jobs:
  open-ports:
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Open NSG Ports (3000 & 8080)
        run: |
          RESOURCE_GROUP="rg-devops-lab"
          NSG_NAME="Linux-VM01-nsg"

          for PORT in 3000 8080; do
            RULE_NAME="Allow-Port-$PORT"
            echo "🔍 Checking if rule $RULE_NAME exists..."
            if az network nsg rule show \
              --resource-group $RESOURCE_GROUP \
              --nsg-name $NSG_NAME \
              --name $RULE_NAME &>/dev/null; then
              echo "Rule $RULE_NAME already exists"
            else
              echo "Creating rule to allow port $PORT"
              az network nsg rule create \
                --resource-group $RESOURCE_GROUP \
                --nsg-name $NSG_NAME \
                --name $RULE_NAME \
                --priority $((1000 + PORT)) \
                --direction Inbound \
                --access Allow \
                --protocol Tcp \
                --destination-port-ranges $PORT \
                --source-address-prefixes '*' \
                --destination-address-prefixes '*' \
                --description "Allow traffic on port $PORT"
            fi
          done
